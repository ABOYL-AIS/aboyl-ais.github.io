<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>问卷跳转中</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: #f5f5f5;
      font-family: "Microsoft YaHei", sans-serif;
    }
    .msg {
      text-align: center;
      font-size: 18px;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="msg" id="msg">正在准备问卷...</div>

<script>
  const msgEl = document.getElementById('msg');

  // --- 兼容 bfcache：页面返回也会触发，保证计数及时更新 ---
  window.addEventListener('pageshow', (e) => {
    console.log('[pageshow]', e.persisted);
  });

  // 1) 回来后+1（通过 localStorage 标记）
  if (localStorage.getItem('has_redirected') === 'true') {
    const done = (parseInt(localStorage.getItem('survey_done_count') || '0') + 1);
    localStorage.setItem('survey_done_count', String(done));
    localStorage.removeItem('has_redirected');
    console.log('[return] done_count =', done);
  }

  // 2) 问卷池
  const urls = [
    "https://www.wjx.cn/vm/OIINUdi.aspx",
    "https://www.wjx.cn/vm/wFuyCIf.aspx",
    "https://www.wjx.cn/vm/eoE3bHt.aspx",
    "https://www.wjx.cn/vm/ty4UqKF.aspx",
    "https://www.wjx.cn/vm/hTmouAO.aspx",
    "https://www.wjx.cn/vm/Y8GWIpm.aspx",
    "https://www.wjx.cn/vm/tCs4UvJ.aspx",
    "https://www.wjx.cn/vm/rgLpid4.aspx",
    "https://www.wjx.cn/vm/PpHqbVx.aspx",
    "https://www.wjx.cn/vm/YDpmxyN.aspx",
    "https://www.wjx.cn/vm/PKWqvJk.aspx",
    "https://www.wjx.cn/vm/QJeHCnD.aspx",
    "https://www.wjx.cn/vm/ts41axa.aspx",
    "https://www.wjx.cn/vm/Ow7KIIi.aspx",
    "https://www.wjx.cn/vm/Ol8i7Kb.aspx",
    "https://www.wjx.cn/vm/QJhFCna.aspx",
    "https://www.wjx.cn/vm/QE0CnaM.aspx",
    "https://www.wjx.cn/vm/OwuVJi7.aspx",
    "https://www.wjx.cn/vm/eI6HtXI.aspx"
  ];

  // 3) 状态
  const params = new URLSearchParams(location.search);
  const debug = params.get('debug') === '1';
  let doneCount = parseInt(localStorage.getItem('survey_done_count') || '0');
  let selected = JSON.parse(localStorage.getItem('selected_indices') || '[]');

  // 4) 完成两份 → 感谢页
  if (doneCount >= 2) {
    console.log('[done] 2/2, go thanks');
    location.replace('thanks.html');
  } else {
    // 5) 首次进入随机选两份
    if (selected.length === 0) {
      const all = [...Array(urls.length).keys()];
      for (let i = all.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [all[i], all[j]] = [all[j], all[i]];
      }
      selected = all.slice(0, 2);
      localStorage.setItem('selected_indices', JSON.stringify(selected));
      console.log('[pick]', selected);
    }

    const idx = selected[doneCount];
    const target = urls[idx];
    msgEl.innerHTML = `正在跳转第 ${doneCount + 1} 份问卷（共2份）…<br><br><a id="fallback" href="${target}" rel="nofollow">若未自动跳转，点此进入</a>`;
    console.log('[goto]', { doneCount, idx, target });

    // 标记将要跳转（用于回来 +1）
    localStorage.setItem('has_redirected', 'true');

    // 6) 立即跳转（更稳），debug 模式下不跳只显示链接
    if (!debug) {
      try {
        location.assign(target); // 比 setTimeout 更可靠
      } catch (e) {
        console.warn('assign failed, use href', e);
        location.href = target;
      }
    }
  }
</script>

</body>
</html>